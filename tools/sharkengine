#!/bin/bash

export SHARKENGINE_APP_HOME=`pwd`

function error {
  echo "Error. Usage:"
  echo "    sharkengine ios setup"
  echo "    sharkengine osx setup"
  echo "    sharkengine android debug [install]"
  echo "    sharkengine android release [install]"
}

function setup_ios {
  echo "building iOS: $SHARKENGINE_APP_HOME"
  process_config
  $SHARKENGINE_HOME/platforms/apple/build/build.sh ios
}

function setup_osx {
  echo "building OS X: $SHARKENGINE_APP_HOME"
  process_config
  $SHARKENGINE_HOME/platforms/apple/build/build.sh osx
}

function build_android {
  echo "building Android: $1 $2 $SHARKENGINE_APP_HOME"  
  process_config
  $SHARKENGINE_HOME/platforms/android/build/build.sh $1 $2
}

function process_config {
  mkdir -p $SHARKENGINE_APP_HOME/out/src
  CONFIG_INCLUDE="$SHARKENGINE_APP_HOME/out/src/sharkengine_config.h"

  echo "// Auto-generated by SharkEngine." > $CONFIG_INCLUDE
  echo "" >> $CONFIG_INCLUDE
  echo "#ifndef SHARKENGINE_APP_CONFIG_H_" >> $CONFIG_INCLUDE
  echo "#define SHARKENGINE_APP_CONFIG_H_" >> $CONFIG_INCLUDE
  echo "" >> $CONFIG_INCLUDE

  while read LINE; do
    KEY=$( echo $LINE | cut -f1 -d= )
    VALUE=$( echo $LINE | cut -f2 -d= )
    eval "export $KEY='$VALUE'"
    echo "#define $KEY $VALUE" >> $CONFIG_INCLUDE  
  done < $SHARKENGINE_APP_HOME/app.config

  echo "" >> $CONFIG_INCLUDE
  echo "#endif" >> $CONFIG_INCLUDE  
}

if [ "$1" = "ios" ] && [ "$2" = "setup" ]; then
  setup_ios
elif [ "$1" = "osx" ] && [ "$2" = "setup" ]; then
  setup_osx
elif [ "$1" = "android" ]; then
  if [ ! $2 = "debug" ] && [ ! $2 = "release" ]; then
    error
  elif [ ! $3 = "" ] && [ ! $3 = "install" ]; then
    error
  else
    build_android $2 $3
  fi
else
  error
fi
